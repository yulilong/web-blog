<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>二、JS代码在nodejs环境下执行机制和事件循环 | 前端知识</title>
    <meta name="description" content="一个总结前端知识的文档网站">
    <link rel="icon" href="/logo.png">
  <script defer="defer" src="/static/jquery.slim.min.js"></script>
  <script defer="defer" src="/static/jquery.fancybox.min.js"></script>
  <link defer="defer" rel="stylesheet" type="text/css" href="/static/jquery.fancybox.min.css">
    
    <link rel="preload" href="/assets/css/0.styles.f853b4b7.css" as="style"><link rel="preload" href="/assets/js/app.d18e3cd8.js" as="script"><link rel="preload" href="/assets/js/26.12012ffc.js" as="script"><link rel="prefetch" href="/assets/js/10.3c978b5a.js"><link rel="prefetch" href="/assets/js/100.9b8f41c4.js"><link rel="prefetch" href="/assets/js/101.dcb14acc.js"><link rel="prefetch" href="/assets/js/102.2a82642e.js"><link rel="prefetch" href="/assets/js/103.55c75880.js"><link rel="prefetch" href="/assets/js/104.a5152a18.js"><link rel="prefetch" href="/assets/js/105.9375539d.js"><link rel="prefetch" href="/assets/js/106.d9f1826b.js"><link rel="prefetch" href="/assets/js/107.d5c5c1f8.js"><link rel="prefetch" href="/assets/js/108.d8593f40.js"><link rel="prefetch" href="/assets/js/109.30a5fddb.js"><link rel="prefetch" href="/assets/js/11.6ab74784.js"><link rel="prefetch" href="/assets/js/110.03c611c8.js"><link rel="prefetch" href="/assets/js/111.fc7ca03e.js"><link rel="prefetch" href="/assets/js/112.367cdd66.js"><link rel="prefetch" href="/assets/js/113.cf7bb4e5.js"><link rel="prefetch" href="/assets/js/114.f57ec866.js"><link rel="prefetch" href="/assets/js/115.fe4cb724.js"><link rel="prefetch" href="/assets/js/116.36ab89d2.js"><link rel="prefetch" href="/assets/js/117.339e33c1.js"><link rel="prefetch" href="/assets/js/118.ea4fdf1f.js"><link rel="prefetch" href="/assets/js/119.2f5e7ad5.js"><link rel="prefetch" href="/assets/js/12.4cec9bb8.js"><link rel="prefetch" href="/assets/js/120.d0b6a627.js"><link rel="prefetch" href="/assets/js/121.4db5f204.js"><link rel="prefetch" href="/assets/js/122.7e8b2e37.js"><link rel="prefetch" href="/assets/js/123.8207072c.js"><link rel="prefetch" href="/assets/js/124.fb8492d2.js"><link rel="prefetch" href="/assets/js/125.14a7b753.js"><link rel="prefetch" href="/assets/js/126.083ab1b8.js"><link rel="prefetch" href="/assets/js/127.ab9e679e.js"><link rel="prefetch" href="/assets/js/128.cc5820bf.js"><link rel="prefetch" href="/assets/js/129.02bea52d.js"><link rel="prefetch" href="/assets/js/13.e972d6f5.js"><link rel="prefetch" href="/assets/js/130.f8ffe2f4.js"><link rel="prefetch" href="/assets/js/131.3c0af687.js"><link rel="prefetch" href="/assets/js/132.aa179cb6.js"><link rel="prefetch" href="/assets/js/133.cc1c8185.js"><link rel="prefetch" href="/assets/js/134.ecc94f2e.js"><link rel="prefetch" href="/assets/js/135.1675c120.js"><link rel="prefetch" href="/assets/js/136.9bb8c110.js"><link rel="prefetch" href="/assets/js/137.9a695475.js"><link rel="prefetch" href="/assets/js/138.5c1831e3.js"><link rel="prefetch" href="/assets/js/139.0a1a42fc.js"><link rel="prefetch" href="/assets/js/14.9ecf3cc3.js"><link rel="prefetch" href="/assets/js/140.3be7077d.js"><link rel="prefetch" href="/assets/js/141.28f54311.js"><link rel="prefetch" href="/assets/js/142.0f732a49.js"><link rel="prefetch" href="/assets/js/143.f881196c.js"><link rel="prefetch" href="/assets/js/144.316091b1.js"><link rel="prefetch" href="/assets/js/145.cadf2477.js"><link rel="prefetch" href="/assets/js/146.5466844b.js"><link rel="prefetch" href="/assets/js/147.7cc8ecd4.js"><link rel="prefetch" href="/assets/js/148.0c7096b4.js"><link rel="prefetch" href="/assets/js/149.b7d0671e.js"><link rel="prefetch" href="/assets/js/15.3282e7bc.js"><link rel="prefetch" href="/assets/js/150.a47e1f20.js"><link rel="prefetch" href="/assets/js/151.36e1b50a.js"><link rel="prefetch" href="/assets/js/152.5d96ea9a.js"><link rel="prefetch" href="/assets/js/153.cc3adca1.js"><link rel="prefetch" href="/assets/js/154.687485c7.js"><link rel="prefetch" href="/assets/js/155.2ea2cbe9.js"><link rel="prefetch" href="/assets/js/156.63062ccb.js"><link rel="prefetch" href="/assets/js/157.755c1908.js"><link rel="prefetch" href="/assets/js/158.40a62d85.js"><link rel="prefetch" href="/assets/js/159.cdfe4c43.js"><link rel="prefetch" href="/assets/js/16.244bcfa5.js"><link rel="prefetch" href="/assets/js/160.68062187.js"><link rel="prefetch" href="/assets/js/161.777109f1.js"><link rel="prefetch" href="/assets/js/162.2b93ef1f.js"><link rel="prefetch" href="/assets/js/163.da08cb7d.js"><link rel="prefetch" href="/assets/js/164.db62a311.js"><link rel="prefetch" href="/assets/js/165.9612d1f6.js"><link rel="prefetch" href="/assets/js/166.5960d960.js"><link rel="prefetch" href="/assets/js/167.2f617057.js"><link rel="prefetch" href="/assets/js/168.771d586a.js"><link rel="prefetch" href="/assets/js/169.87844344.js"><link rel="prefetch" href="/assets/js/17.00bdfaf3.js"><link rel="prefetch" href="/assets/js/170.5ad0f0fe.js"><link rel="prefetch" href="/assets/js/171.22786ba3.js"><link rel="prefetch" href="/assets/js/172.49e5451f.js"><link rel="prefetch" href="/assets/js/173.7462313e.js"><link rel="prefetch" href="/assets/js/174.54b4d11a.js"><link rel="prefetch" href="/assets/js/175.864a2fa0.js"><link rel="prefetch" href="/assets/js/176.be990953.js"><link rel="prefetch" href="/assets/js/177.c8d7cc4b.js"><link rel="prefetch" href="/assets/js/178.ad23f326.js"><link rel="prefetch" href="/assets/js/179.a3371a0b.js"><link rel="prefetch" href="/assets/js/18.08f61532.js"><link rel="prefetch" href="/assets/js/180.5f048298.js"><link rel="prefetch" href="/assets/js/181.7067dd7e.js"><link rel="prefetch" href="/assets/js/182.bf312b74.js"><link rel="prefetch" href="/assets/js/183.a89af512.js"><link rel="prefetch" href="/assets/js/19.242fcc4c.js"><link rel="prefetch" href="/assets/js/20.d4eaf7fd.js"><link rel="prefetch" href="/assets/js/21.f10b82b9.js"><link rel="prefetch" href="/assets/js/22.396ecbe9.js"><link rel="prefetch" href="/assets/js/23.2a295290.js"><link rel="prefetch" href="/assets/js/24.e3566310.js"><link rel="prefetch" href="/assets/js/25.46b7f0f7.js"><link rel="prefetch" href="/assets/js/27.b93a3bc5.js"><link rel="prefetch" href="/assets/js/28.3ea2eb49.js"><link rel="prefetch" href="/assets/js/29.00cbeabe.js"><link rel="prefetch" href="/assets/js/3.b6ed6d58.js"><link rel="prefetch" href="/assets/js/30.a7935a4d.js"><link rel="prefetch" href="/assets/js/31.6d248f8a.js"><link rel="prefetch" href="/assets/js/32.f9afe09b.js"><link rel="prefetch" href="/assets/js/33.939c22ed.js"><link rel="prefetch" href="/assets/js/34.a464644d.js"><link rel="prefetch" href="/assets/js/35.e0524ba3.js"><link rel="prefetch" href="/assets/js/36.5688d8bd.js"><link rel="prefetch" href="/assets/js/37.7896942a.js"><link rel="prefetch" href="/assets/js/38.253f4230.js"><link rel="prefetch" href="/assets/js/39.9918fed7.js"><link rel="prefetch" href="/assets/js/4.8438802a.js"><link rel="prefetch" href="/assets/js/40.1d42dfef.js"><link rel="prefetch" href="/assets/js/41.76b0c57f.js"><link rel="prefetch" href="/assets/js/42.e52038b9.js"><link rel="prefetch" href="/assets/js/43.fc6145a7.js"><link rel="prefetch" href="/assets/js/44.ed10f39c.js"><link rel="prefetch" href="/assets/js/45.f9f0d3ba.js"><link rel="prefetch" href="/assets/js/46.f7837284.js"><link rel="prefetch" href="/assets/js/47.669d5c62.js"><link rel="prefetch" href="/assets/js/48.88990bb5.js"><link rel="prefetch" href="/assets/js/49.eedc9b6d.js"><link rel="prefetch" href="/assets/js/5.4b3327ea.js"><link rel="prefetch" href="/assets/js/50.38863926.js"><link rel="prefetch" href="/assets/js/51.5a4009b9.js"><link rel="prefetch" href="/assets/js/52.53824857.js"><link rel="prefetch" href="/assets/js/53.fed8ed8c.js"><link rel="prefetch" href="/assets/js/54.2828e1eb.js"><link rel="prefetch" href="/assets/js/55.15a29884.js"><link rel="prefetch" href="/assets/js/56.a1e8dd20.js"><link rel="prefetch" href="/assets/js/57.a193beae.js"><link rel="prefetch" href="/assets/js/58.a35586fc.js"><link rel="prefetch" href="/assets/js/59.298e7a30.js"><link rel="prefetch" href="/assets/js/6.8f8061d5.js"><link rel="prefetch" href="/assets/js/60.309949d3.js"><link rel="prefetch" href="/assets/js/61.5b2438a2.js"><link rel="prefetch" href="/assets/js/62.0b6fc5ab.js"><link rel="prefetch" href="/assets/js/63.9e907533.js"><link rel="prefetch" href="/assets/js/64.cf2f109e.js"><link rel="prefetch" href="/assets/js/65.2e76882c.js"><link rel="prefetch" href="/assets/js/66.1e168f9f.js"><link rel="prefetch" href="/assets/js/67.b8fa7712.js"><link rel="prefetch" href="/assets/js/68.40717004.js"><link rel="prefetch" href="/assets/js/69.54334dfe.js"><link rel="prefetch" href="/assets/js/7.d1c694a0.js"><link rel="prefetch" href="/assets/js/70.e98d0df3.js"><link rel="prefetch" href="/assets/js/71.e6e23663.js"><link rel="prefetch" href="/assets/js/72.72ec9dd5.js"><link rel="prefetch" href="/assets/js/73.c573567c.js"><link rel="prefetch" href="/assets/js/74.e6428ff0.js"><link rel="prefetch" href="/assets/js/75.49650c1b.js"><link rel="prefetch" href="/assets/js/76.810190c5.js"><link rel="prefetch" href="/assets/js/77.4316f3d1.js"><link rel="prefetch" href="/assets/js/78.41e6fcb1.js"><link rel="prefetch" href="/assets/js/79.d90102bc.js"><link rel="prefetch" href="/assets/js/8.c1134aff.js"><link rel="prefetch" href="/assets/js/80.67f442b0.js"><link rel="prefetch" href="/assets/js/81.58cd2086.js"><link rel="prefetch" href="/assets/js/82.0af25307.js"><link rel="prefetch" href="/assets/js/83.57cb0313.js"><link rel="prefetch" href="/assets/js/84.7c4c1b25.js"><link rel="prefetch" href="/assets/js/85.f07b510a.js"><link rel="prefetch" href="/assets/js/86.3252a34b.js"><link rel="prefetch" href="/assets/js/87.32c33b26.js"><link rel="prefetch" href="/assets/js/88.1a13f763.js"><link rel="prefetch" href="/assets/js/89.ce95ef88.js"><link rel="prefetch" href="/assets/js/9.cc043a67.js"><link rel="prefetch" href="/assets/js/90.4900a855.js"><link rel="prefetch" href="/assets/js/91.db19c502.js"><link rel="prefetch" href="/assets/js/92.cadb5507.js"><link rel="prefetch" href="/assets/js/93.59c3b44d.js"><link rel="prefetch" href="/assets/js/94.0c53fb42.js"><link rel="prefetch" href="/assets/js/95.69e14251.js"><link rel="prefetch" href="/assets/js/96.abcd14db.js"><link rel="prefetch" href="/assets/js/97.219ac966.js"><link rel="prefetch" href="/assets/js/98.c7176d4a.js"><link rel="prefetch" href="/assets/js/99.6bee146d.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.f48d90bd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f853b4b7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="前端知识" class="logo"> <span class="site-name can-hide">前端知识</span></a> <div class="links" style="max-width:nullpx;"><form id="search-form" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/catalog.html" class="nav-link">目录</a></div><div class="nav-item"><a href="/doc/es6/" class="nav-link">ES6</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc/js/" class="nav-link router-link-active">js</a></li><li class="dropdown-item"><!----> <a href="/doc/js/standardLibrary/" class="nav-link">js标准库</a></li><li class="dropdown-item"><!----> <a href="/doc/dom/" class="nav-link">dom操作文档</a></li><li class="dropdown-item"><!----> <a href="/doc/browserNetwork/" class="nav-link">浏览器、网络</a></li><li class="dropdown-item"><!----> <a href="/doc/designPattern/" class="nav-link">设计模式</a></li></ul></div></div><div class="nav-item"><a href="/doc/css/" class="nav-link">CSS</a></div><div class="nav-item"><a href="/doc/html/" class="nav-link">html</a></div><div class="nav-item"><a href="/doc/react/" class="nav-link">react</a></div><div class="nav-item"><a href="/doc/vue/" class="nav-link">vue</a></div><div class="nav-item"><a href="/doc/node/" class="nav-link">node</a></div><div class="nav-item"><a href="/doc/tool/" class="nav-link">工具</a></div> <a href="https://github.com/yulilong/front-end-doc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/catalog.html" class="nav-link">目录</a></div><div class="nav-item"><a href="/doc/es6/" class="nav-link">ES6</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">javascript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/doc/js/" class="nav-link router-link-active">js</a></li><li class="dropdown-item"><!----> <a href="/doc/js/standardLibrary/" class="nav-link">js标准库</a></li><li class="dropdown-item"><!----> <a href="/doc/dom/" class="nav-link">dom操作文档</a></li><li class="dropdown-item"><!----> <a href="/doc/browserNetwork/" class="nav-link">浏览器、网络</a></li><li class="dropdown-item"><!----> <a href="/doc/designPattern/" class="nav-link">设计模式</a></li></ul></div></div><div class="nav-item"><a href="/doc/css/" class="nav-link">CSS</a></div><div class="nav-item"><a href="/doc/html/" class="nav-link">html</a></div><div class="nav-item"><a href="/doc/react/" class="nav-link">react</a></div><div class="nav-item"><a href="/doc/vue/" class="nav-link">vue</a></div><div class="nav-item"><a href="/doc/node/" class="nav-link">node</a></div><div class="nav-item"><a href="/doc/tool/" class="nav-link">工具</a></div> <a href="https://github.com/yulilong/front-end-doc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/doc/js/" class="one-level sidebar-link">JavaScript部分说明</a></li><li><a href="/doc/js/001-对象原型继承.html" class="one-level sidebar-link">对象原型继承</a></li><li><a href="/doc/js/002-this_call_apply_bind.html" class="one-level sidebar-link">this、call、apply、bind</a></li><li><a href="/doc/js/003-数据类型转换.html" class="one-level sidebar-link">数据类型转换</a></li><li><a href="/doc/js/004-跨域.html" class="one-level sidebar-link">跨域</a></li><li><a href="/doc/js/005-Ajax.html" class="one-level sidebar-link">Ajax</a></li><li><a href="/doc/js/006-函数.html" class="one-level sidebar-link">函数</a></li><li><a href="/doc/js/007-作用域.html" class="one-level sidebar-link">作用域</a></li><li><a href="/doc/js/008-排序算法.html" class="one-level sidebar-link">排序算法</a></li><li><a href="/doc/js/009-获取标签宽高及实例.html" class="one-level sidebar-link">获取标签的宽高及例子</a></li><li><a href="/doc/js/010-从输入URL到页面渲染过程.html" class="one-level sidebar-link">从输入URL到页面渲染过程</a></li><li><a href="/doc/js/013-JS浮点数运算的精度问题.html" class="one-level sidebar-link">JavaScript浮点数运算的精度问题</a></li><li><a href="/doc/js/014-Web-Worker使用教程.html" class="one-level sidebar-link">Web Worker 使用教程</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>JS代码执行机制和事件循环</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/doc/js/jsHowWork/JS在浏览器中运行机制和事件循环.html" class="one-level sidebar-link">一、JS在浏览器中运行机制和事件循环</a></li><li><a href="/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.html" class="one-level one-level-active active sidebar-link">二、JS代码在nodejs环境下执行机制和事件循环</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.html#_1-说明" class="sidebar-link">1. 说明</a></li><li class="sidebar-sub-header"><a href="/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.html#_2-nodejs的启动过程" class="sidebar-link">2. nodejs的启动过程</a></li><li class="sidebar-sub-header"><a href="/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.html#_3-nodejs的事件循环详解" class="sidebar-link">3. nodejs的事件循环详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.html#_3-1-timer-阶段" class="sidebar-link">3.1 Timer 阶段</a></li><li class="sidebar-sub-header"><a href="/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.html#_3-2-pending-i-o-callback-阶段" class="sidebar-link">3.2 Pending I/O Callback 阶段</a></li><li class="sidebar-sub-header"><a href="/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.html#_3-3-idle-prepare-阶段" class="sidebar-link">3.3 Idle, Prepare 阶段</a></li><li class="sidebar-sub-header"><a href="/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.html#_3-4-poll-阶段，重要阶段" class="sidebar-link">3.4 Poll 阶段，重要阶段</a></li><li class="sidebar-sub-header"><a href="/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.html#_3-5-check-阶段" class="sidebar-link">3.5 Check  阶段</a></li><li class="sidebar-sub-header"><a href="/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.html#_3-6-close-callbacks-阶段" class="sidebar-link">3.6 Close Callbacks 阶段</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.html#_4-nodejs执行js代码过程及事件循环过程" class="sidebar-link">4. nodejs执行JS代码过程及事件循环过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.html#_4-1-关于promise和process-nexttick" class="sidebar-link">4.1 关于Promise和process.nextTick</a></li><li class="sidebar-sub-header"><a href="/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.html#_4-2-关于settimeout-…-0-和-setimmediate" class="sidebar-link">4.2 关于setTimeout(…, 0) 和 setImmediate</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.html#_5-一个实际例子演示" class="sidebar-link">5. 一个实际例子演示</a></li><li class="sidebar-sub-header"><a href="/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.html#参考资料" class="sidebar-link">参考资料</a></li></ul></li><li><a href="/doc/js/jsHowWork/JS中异步方法.html" class="one-level sidebar-link">三、JS中异步方法</a></li><li><a href="/doc/js/jsHowWork/EventLoop和浏览器渲染-帧动画-空闲回调的关系.html" class="one-level sidebar-link">EventLoop 和浏览器渲染、帧动画、空闲回调的关系</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>高级</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>文章</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>浏览器模型</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><p></p><div class="table-of-contents"><ul><li><a href="#_1-说明">1. 说明</a></li><li><a href="#_2-nodejs的启动过程">2. nodejs的启动过程</a></li><li><a href="#_3-nodejs的事件循环详解">3. nodejs的事件循环详解</a><ul><li><a href="#_3-1-timer-阶段">3.1 Timer 阶段</a></li><li><a href="#_3-2-pending-i-o-callback-阶段">3.2 Pending I/O Callback 阶段</a></li><li><a href="#_3-3-idle-prepare-阶段">3.3 Idle, Prepare 阶段</a></li><li><a href="#_3-4-poll-阶段，重要阶段">3.4 Poll 阶段，重要阶段</a></li><li><a href="#_3-5-check-阶段">3.5 Check  阶段</a></li><li><a href="#_3-6-close-callbacks-阶段">3.6 Close Callbacks 阶段</a></li></ul></li><li><a href="#_4-nodejs执行js代码过程及事件循环过程">4. nodejs执行JS代码过程及事件循环过程</a><ul><li><a href="#_4-1-关于promise和process-nexttick">4.1 关于Promise和process.nextTick</a></li><li><a href="#_4-2-关于settimeout-…-0-和-setimmediate">4.2 关于setTimeout(…, 0) 和 setImmediate</a></li></ul></li><li><a href="#_5-一个实际例子演示">5. 一个实际例子演示</a></li><li><a href="#参考资料">参考资料</a></li></ul></div><p></p> <p>[TOC]</p> <h1 id="二、js代码在nodejs环境下执行机制和事件循环"><a href="#二、js代码在nodejs环境下执行机制和事件循环" aria-hidden="true" class="header-anchor">#</a> 二、JS代码在nodejs环境下执行机制和事件循环</h1> <h2 id="_1-说明"><a href="#_1-说明" aria-hidden="true" class="header-anchor">#</a> 1. 说明</h2> <p>本文大部分参考了：https://blog.csdn.net/i10630226/article/details/81369841</p> <p>nodejs是单线程执行的，同时它又是基于事件驱动的非阻塞IO编程模型。这就使得我们不用等待异步操作结果返回，就可以继续往下执行代码。当异步事件触发之后，就会通知主线程，主线程执行相应事件的回调。</p> <p>本篇文章讲解node中JavaScript的代码的执行流程，下面是测试代码，如果你知道输出的结果，那么就不需要再看本篇文章，如果不知道输出结果，那么本片文章可帮助你了解：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>复杂的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'6'</span><span class="token punctuation">)</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'7'</span><span class="token punctuation">)</span>
      <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'9'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'11'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'13'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'14'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'15'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'16'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'18'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_2-nodejs的启动过程"><a href="#_2-nodejs的启动过程" aria-hidden="true" class="header-anchor">#</a> 2. nodejs的启动过程</h2> <p>node.js启动过程可以分为以下步骤：</p> <ol><li><p>调用platformInit方法 ，初始化 nodejs 的运行环境。</p></li> <li><p>调用 performance_node_start 方法，对 nodejs 进行性能统计。</p></li> <li><p>openssl设置的判断。</p></li> <li><p>调用v8_platform.Initialize，初始化 libuv 线程池。</p></li> <li><p>调用 V8::Initialize，初始化 V8 环境。</p></li> <li><p>创建一个nodejs运行实例。</p></li> <li><p>启动上一步创建好的实例。</p></li> <li><p>开始执行js文件，同步代码执行完毕后，进入事件循环。</p></li> <li><p>在没有任何可监听的事件时，销毁 nodejs 实例，程序执行完毕。</p></li></ol> <p><img src="/assets/img/001-nodejs.f9c11eee.png" alt></p> <h2 id="_3-nodejs的事件循环详解"><a href="#_3-nodejs的事件循环详解" aria-hidden="true" class="header-anchor">#</a> 3. nodejs的事件循环详解</h2> <p>Nodejs 将消息循环又细分为 6 个阶段(官方叫做 Phase), 每个阶段都会有一个类似于队列的结构, 存储着该阶段需要处理的回调函数.</p> <p>Nodejs 为了防止某个 阶段 任务太多, 导致后续的 阶段 发生饥饿的现象, 所以消息循环的每一个迭代(iterate) 中, 每个 阶段 执行回调都有个最大数量. 如果超过数量的话也会强行结束当前 阶段而进入下一个 阶段. 这一条规则适用于消息循环中的每一个 阶段.</p> <h3 id="_3-1-timer-阶段"><a href="#_3-1-timer-阶段" aria-hidden="true" class="header-anchor">#</a> 3.1 Timer 阶段</h3> <p>这是消息循环的第一个阶段, 用一个 <code>for</code> 循环处理所有 <code>setTimeout</code> 和 <code>setInterval</code> 的回调.</p> <p>这些回调被保存在一个最小堆(min heap) 中. 这样引擎只需要每次判断头元素, 如果符合条件就拿出来执行, 直到遇到一个不符合条件或者队列空了, 才结束 Timer Phase.</p> <p>Timer 阶段中判断某个回调是否符合条件的方法也很简单. 消息循环每次进入 Timer 的时候都会保存一下当时的系统时间,然后只要看上述最小堆中的回调函数设置的启动时间是否超过进入 Timer 时保存的时间, 如果超过就拿出来执行.</p> <h3 id="_3-2-pending-i-o-callback-阶段"><a href="#_3-2-pending-i-o-callback-阶段" aria-hidden="true" class="header-anchor">#</a> 3.2 Pending I/O Callback 阶段</h3> <p>执行除了<code>close callbacks</code>、<code>setTimeout()</code>、<code>setInterval()</code>、<code>setImmediate()</code>回调之外几乎所有回调，比如说<code>TCP连接发生错误</code>、 <code>fs.read</code>, <code>socket</code> 等 IO 操作的回调函数, 同时也包括各种 error 的回调.</p> <h3 id="_3-3-idle-prepare-阶段"><a href="#_3-3-idle-prepare-阶段" aria-hidden="true" class="header-anchor">#</a> 3.3 Idle, Prepare 阶段</h3> <p>系统内部的一些调用。</p> <h3 id="_3-4-poll-阶段，重要阶段"><a href="#_3-4-poll-阶段，重要阶段" aria-hidden="true" class="header-anchor">#</a> 3.4 Poll 阶段，重要阶段</h3> <p>这是整个消息循环中最重要的一个 阶段, 作用是等待异步请求和数据，因为它支撑了整个消息循环机制.</p> <p>poll阶段有两个主要的功能：一是执行下限时间已经达到的timers的回调，一是处理poll队列里的事件。
***注：***Node的很多API都是基于事件订阅完成的，比如fs.readFile，这些回调应该都在<code>poll</code>阶段完成。</p> <p>当事件循环进入poll阶段：</p> <ul><li><code>poll</code>队列不为空的时候，事件循环肯定是先遍历队列并同步执行回调，直到队列清空或执行回调数达到系统上限。</li> <li><code>poll</code>队列为空的时候，这里有两种情况。
<ul><li>如果代码已经被<code>setImmediate()</code>设定了回调，那么事件循环直接结束<code>poll</code>阶段进入<code>check</code>阶段来执行<code>check</code>队列里的回调。</li> <li>如果代码没有被设定<code>setImmediate()</code>设定回调：
<ul><li>如果有被设定的timers，那么此时事件循环会检查timers，如果有一个或多个timers下限时间已经到达，那么事件循环将绕回timers阶段，并执行timers的有效回调队列。</li> <li>如果没有被设定timers，这个时候事件循环是<strong>阻塞</strong>在poll阶段等待事件回调被加入poll队列。</li></ul></li></ul></li></ul> <p>Poll阶段，当js层代码注册的事件回调都没有返回的时候，事件循环会暂时阻塞在poll阶段，解除阻塞的条件：</p> <blockquote><ol><li><p>在poll阶段执行的时候，会传入一个timeout超时时间，该超时时间就是poll阶段的最大阻塞时间。</p></li> <li><p>timeout时间未到的时候，如果有事件返回，就执行该事件注册的回调函数。timeout超时时间到了，则退出poll阶段，执行下一个阶段。</p></li></ol> <p>这个 timeout 设置为多少合适呢? 答案就是 Timer Phase 中最近要执行的回调启动时间到现在的差值, 假设这个差值是 detal. 因为 Poll Phase 后面没有等待执行的回调了. 所以这里最多等待 delta 时长, 如果期间有事件唤醒了消息循环, 那么就继续下一个 Phase 的工作; 如果期间什么都没发生, 那么到了 timeout 后, 消息循环依然要进入后面的 Phase, 让下一个迭代的 Timer Phase 也能够得到执行.
Nodejs 就是通过 Poll Phase, 对 IO 事件的等待和内核异步事件的到达来驱动整个消息循环的.</p></blockquote> <h3 id="_3-5-check-阶段"><a href="#_3-5-check-阶段" aria-hidden="true" class="header-anchor">#</a> 3.5 Check  阶段</h3> <p>这个阶段只处理 setImmediate 的回调函数.
那么为什么这里要有专门一个处理 setImmediate 的 阶段 呢? 简单来说, 是因为 Poll 阶段可能设置一些回调, 希望在 Poll 阶段 后运行. 所以在 Poll 阶段 后面增加了这个 Check 阶段.</p> <h3 id="_3-6-close-callbacks-阶段"><a href="#_3-6-close-callbacks-阶段" aria-hidden="true" class="header-anchor">#</a> 3.6 Close Callbacks 阶段</h3> <p>专门处理一些 close 类型的回调. 比如 <code>socket.on('close', ...)</code>. 用于资源清理.</p> <h2 id="_4-nodejs执行js代码过程及事件循环过程"><a href="#_4-nodejs执行js代码过程及事件循环过程" aria-hidden="true" class="header-anchor">#</a> 4. nodejs执行JS代码过程及事件循环过程</h2> <ul><li><p>1、node初始化</p> <ul><li>初始化node环境</li> <li>执行输入的代码</li> <li>执行<code>process.nextTick</code>回调</li> <li>执行微任务(microtasks)</li></ul></li> <li><p>2、进入事件循环</p> <ul><li><p>2.1、进入<code>Timer</code>阶段</p> <ul><li>检查<code>Timer</code>队列是否有到期的<code>Timer</code>的回调，如果有，将到期的所有<code>Timer</code>回调按照<code>TimerId</code>升序执行</li> <li>检查是否有<code>process.nextTick</code>任务，如果有，全部执行</li> <li>检查是否有微任务(promise)，如果有，全部执行</li> <li>退出该阶段</li></ul></li> <li><p>2.2、进入<code>Pending I/O Callback</code>阶段</p> <ul><li>检查是否有<code>Pending I/O Callback</code>的回调，如果有，执行回调。<strong>如果没有退出该阶段</strong></li> <li>检查是否有<code>process.nextTick</code>任务，如果有，全部执行</li> <li>检查是否有微任务(promise)，如果有，全部执行</li> <li>退出该阶段</li></ul></li> <li><p>2.3、进入<code>idle，prepare</code>阶段</p> <p>这个阶段与JavaScript关系不大，略过</p></li> <li><p>2.4、进入<code>Poll</code>阶段</p> <ul><li><p>首先检查是否存在尚未完成的回调，如果存在，分如下两种情况：</p> <ul><li>第一种情况：有可执行的回调
<ul><li>执行所有可用回调(包含到期的定时器还有一些IO事件等)</li> <li>检查是否有<code>process.nextTick</code>任务，如果有，全部执行</li> <li>检查是否有微任务(promise)，如果有，全部执行</li> <li>退出该阶段</li></ul></li> <li>第二种情况：没有可执行的回调
<ul><li>检查是否有<code>immediate</code>回调，如果有，退出Poll阶段。如果没有，阻塞在此阶段，等待新的事件通知</li></ul></li></ul></li> <li><p>如果不存在尚未完成的回调，退出Poll阶段</p></li></ul></li> <li><p>2.5、进入<code>check</code>阶段</p> <ul><li>如果有immediate回调，则执行所有immediate回调</li> <li>检查是否有<code>process.nextTick</code>任务，如果有，全部执行</li> <li>检查是否有微任务(promise)，如果有，全部执行</li> <li>退出该阶段</li></ul></li> <li><p>2.6、进入<code>closing</code>阶段</p> <ul><li>如果有immediate回调，则执行所有immediate回调</li> <li>检查是否有<code>process.nextTick</code>任务，如果有，全部执行</li> <li>检查是否有微任务(promise)，如果有，全部执行</li> <li>退出该阶段</li></ul></li></ul></li> <li><p>3、检查是否有活跃的<code>handles(定时器、IO等事件句柄)</code></p> <ul><li>如果有，继续下一轮事件循环</li> <li>如果没有，结束事件循环，退出程序</li></ul></li></ul> <p><em><strong>注意：</strong></em></p> <p>事件循环的每一个子阶段退出之前都会按顺序执行如下过程：</p> <ul><li>检查是否有 process.nextTick 回调，如果有，全部执行。</li> <li>检查是否有 微任务(promise)，如果有，全部执行。</li></ul> <h3 id="_4-1-关于promise和process-nexttick"><a href="#_4-1-关于promise和process-nexttick" aria-hidden="true" class="header-anchor">#</a> 4.1 关于Promise和process.nextTick</h3> <p>事件循环队列先保证所有的<code>process.nextTick</code>回调，然后将所有的<code>Promise</code>回调追加在后面，最终在每个阶段结束的时候一次性拿出来执行。</p> <p>此外，<code>process.nextTick</code>和<code>Promise</code>回调的数量是受限制的，也就是说，如果一直往这个队列中加入回调，那么整个事件循环就会被<code>卡住</code>。</p> <p><img src="/assets/img/002-nodejs.91957452.png" alt></p> <h3 id="_4-2-关于settimeout-…-0-和-setimmediate"><a href="#_4-2-关于settimeout-…-0-和-setimmediate" aria-hidden="true" class="header-anchor">#</a> 4.2 关于setTimeout(…, 0) 和 setImmediate</h3> <p>这两个方法的回调到底谁快？</p> <p>如下面的例子：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>使用nodejs多次执行后，发现输出结果有时是<code>1 2</code>,有时是<code>2 1</code>。</p> <p>对于多次执行输出结果不同，需要了解事件循环的基础问题。</p> <p>首先,Nodejs启动,初始化环境后加载我们的JS代码(index.js).发生了两件事(此时尚未进入消息循环环节):</p> <blockquote><p>setImmediate 向 Check 阶段 中添加了回调 console.log(2);</p> <p>setTimeout 向 Timer 阶段 中添加了回调 console.log(1)</p></blockquote> <p>这时候, 要初始化阶段完毕, 要进入 Nodejs 消息循环了。</p> <p>为什么会有两种输出呢? 接下来一步很关键:</p> <p>当执行到 Timer 阶段 时, 会发生两种可能. 因为每一轮迭代刚刚进入 Timer 阶段 时会取系统时间保存起来, 以 ms(毫秒) 为最小单位.</p> <p>如果 Timer 阶段 中回调预设的时间 &gt; 消息循环所保存的时间, 则执行 Timer 阶段 中的该回调. 这种情况下先输出 1, 直到 Check 阶段 执行后,输出2.总的来说, 结果是 1 2.</p> <p>如果运行比较快, Timer 阶段 中回调预设的时间可能刚好等于消息循环所保存的时间, 这种情况下, Timer 阶段 中的回调得不到执行, 则继续下一个 阶段. 直到 Check 阶段, 输出 2. 然后等下一轮迭代的 Timer 阶段, 这时的时间一定是满足 Timer 阶段 中回调预设的时间 &gt; 消息循环所保存的时间 , 所以 console.log(1) 得到执行, 输出 1. 总的来说, 结果就是 2 1.</p> <p>所以, 输出不稳定的原因就取决于进入 Timer 阶段 的时间是否和执行 setTimeout 的时间在 1ms 内. 如果把代码改成如下, 则一定会得到稳定的输出:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'my-file-path.txt'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这是因为消息循环在 <code>Pneding I/O Phase</code> 才向 Timer 和 Check 队列插入回调. 这时按照消息循环的执行顺序, Check 一定在 Timer 之前执行。</p> <p>从性能角度讲, setTimeout 的处理是在 Timer Phase, 其中 min heap 保存了 timer 的回调, 因此每执行一个回调的同时都会涉及到堆调整. 而 setImmediate 仅仅是清空一个队列. 效率自然会高很多.</p> <p>再从执行时机上讲. setTimeout(..., 0) 和 setImmediate 完全属于两个阶段.</p> <h2 id="_5-一个实际例子演示"><a href="#_5-一个实际例子演示" aria-hidden="true" class="header-anchor">#</a> 5. 一个实际例子演示</h2> <p>下面以一段代码来说明nodejs运行JavaScript的机制。</p> <p>如下面一段代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>                                                <span class="token comment">// settimeout1</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>      <span class="token comment">// Promise3</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>         <span class="token comment">// Promise4</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>                                              <span class="token comment">// settimeout3</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'6'</span><span class="token punctuation">)</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>                                            <span class="token comment">// settimeout5</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'7'</span><span class="token punctuation">)</span>
      <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token comment">// Promise5</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'9'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// Promise6</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'11'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>                    <span class="token comment">// settimeout6</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'13'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>                      <span class="token comment">// settimeout4</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'14'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>                        <span class="token comment">// settimeout2</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'15'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token comment">// Promise1</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'16'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'17'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token comment">// Promise2</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'18'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上面代码执行过程：</p> <ul><li>node初始化
<ul><li>执行JavaScript代码
<ul><li>遇到<code>setTimeout</code>, 把回调函数放到<code>Timer</code>队列中，记为settimeout1</li> <li>遇到<code>setTimeout</code>, 把回调函数放到<code>Timer</code>队列中，记为settimeout2</li> <li>遇到<code>Promise</code>，执行，输出15，把回调函数放到<code>微任务</code>队列，记为Promise1</li> <li>遇到<code>Promise</code>，执行，输出17，把回调函数放到<code>微任务</code>队列，记为Promise2</li> <li>代码执行结束，此阶段输出结果：<code>15 17</code></li></ul></li> <li>没有<code>process.nextTick</code>回调，略过</li> <li>执行微任务
<ul><li>检查微任务队列是否有可执行回调，此时队列有2个回调：Promise1、Promise2</li> <li>执行Promise1回调，输出16</li> <li>执行Promise2回调，输出18</li> <li>此阶段输出结果：<code>16 18</code></li></ul></li></ul></li> <li>进入第一次事件循环
<ul><li>进入Timer阶段
<ul><li>检查Timer队列是否有可执行的回调，此时队列有2个回调：settimeout1、settimeout2</li> <li>执行settimeout1回调：
<ul><li>输出1、2、4</li> <li>添加了2个微任务，记为Promise3、Promise4</li> <li>添加了2个Timer任务，记为settimeout3、settimeout4</li></ul></li> <li>执行settimeout2回调，输出14</li> <li>Timer队列任务执行完毕</li> <li>没有<code>process.nextTick</code>回调，略过</li> <li>检查微任务队列是否有可执行回调，此时队列有2个回调：Promise3、Promise4</li> <li>按顺序执行2个微任务，输出3、5</li> <li>此阶段输出结果：<code>1 2 4 14 3 5</code></li></ul></li> <li>Pending I/O Callback阶段没有任务，略过</li> <li>进入 Poll 阶段
<ul><li>检查是否存在尚未完成的回调，此时有2个回调：settimeout3、settimeout4</li> <li>执行settimeout3回调
<ul><li>输出6</li> <li>添加了2个Timer任务，记为settimeout5、settimeout6</li></ul></li> <li>执行settimeout4回调，输出13</li> <li>没有<code>process.nextTick</code>回调，略过</li> <li>没有微任务，略过</li> <li>此阶段输出结果：<code>6 13</code></li></ul></li> <li>check、closing阶段没有任务，略过</li> <li>检查是否还有活跃的<code>handles(定时器、IO等事件句柄)</code>,有，继续下一轮事件循环</li></ul></li> <li>进入第二次事件循环
<ul><li>进入Timer阶段
<ul><li>检查Timer队列是否有可执行的回调，此时队列有2个回调：settimeout5、settimeout6</li> <li>执行settimeout5回调：
<ul><li>输出7、 8、10</li> <li>添加了2个微任务，记为Promise5、Promise6</li></ul></li> <li>执行settimeout6回调，输出12</li> <li>没有<code>process.nextTick</code>回调，略过</li> <li>检查微任务队列是否有可执行回调，此时队列有2个回调：Promise5、Promise6</li> <li>按顺序执行2个微任务，输出9、11</li> <li>此阶段输出结果：<code>7 8 10 12 9 11</code></li></ul></li> <li>Pending I/O Callback、Poll、check、closing阶段没有任务，略过</li> <li>检查是否还有活跃的<code>handles(定时器、IO等事件句柄)</code>,没有了，结束事件循环，退出程序</li></ul></li> <li>程序执行结束，输出结果：<code>15 17 16 18 1 2 4 14 3 5 6 13 7 8 10 12 9 11</code></li></ul> <p><img src="/assets/img/noderesult.a8f1b862.png" alt></p> <h2 id="参考资料"><a href="#参考资料" aria-hidden="true" class="header-anchor">#</a> 参考资料</h2> <p><a href="https://blog.csdn.net/i10630226/article/details/81369841" target="_blank" rel="noopener noreferrer">深入分析Node.js事件循环与消息队列<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://juejin.im/post/5af1413ef265da0b851cce80" target="_blank" rel="noopener noreferrer">剖析nodejs的事件循环<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://segmentfault.com/a/1190000012648569" target="_blank" rel="noopener noreferrer">Node中的事件循环和异步API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/#process-nexttick" target="_blank" rel="noopener noreferrer">Node.js Event Loop nodejs官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/yulilong/front-end-doc/edit/master/doc/js/jsHowWork/JS代码在nodejs环境下执行机制和事件循环.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">10/25/2019, 1:16:28 AM</span></div></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/26.12012ffc.js" defer></script><script src="/assets/js/app.d18e3cd8.js" defer></script>
  </body>
</html>
